services:
  # ===========================================
  # Frontend Dashboard
  # ===========================================
  creationhub:
    build: 
      context: .
      args:
        - VITE_SUPABASE_URL=/api/v1
        - VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoicG9zdGdyZXMiLCJleHAiOjIwODE2NzIxNTF9.230cB1C85ECp3N5eXO4xOXabWYbA7bEVqDQ87tM1ZJ4
    container_name: creationhub
    ports:
      - "7777:80"
    restart: always
    depends_on:
      postgrest:
        condition: service_started
    environment:
      - VITE_SUPABASE_URL=/api/v1
      - VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoicG9zdGdyZXMiLCJleHAiOjIwODE2NzIxNTF9.230cB1C85ECp3N5eXO4xOXabWYbA7bEVqDQ87tM1ZJ4
    networks:
      - default
      - creationhub-backend
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:80/"]
      interval: 60s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================
  # PostgREST API
  # ===========================================
  postgrest:
    image: postgrest/postgrest
    container_name: creationhub_api
    # SECURITY: Internal only - access via nginx proxy /api/v1/
    ports:
      - "127.0.0.1:3000:3000"  # SECURITY: Localhost only
    environment:
      PGRST_DB_URI: "postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-changeme}@creationhub-postgres:5432/${POSTGRES_DB:-postgres}"
      PGRST_DB_SCHEMA: public
      PGRST_DB_ANON_ROLE: ${POSTGRES_USER:-postgres}
      PGRST_JWT_SECRET: "${JWT_SECRET:-super-secret-jwt-key-for-creationhub-2024}"
    restart: always
    networks:
      - default
      - creationhub-backend
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/"]
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================
  # Stats Recorder (System Metrics)
  # ===========================================
  stats-recorder:
    build: ./stats-recorder
    container_name: creationhub_stats
    restart: always
    environment:
      - DATABASE_URL=postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-changeme}@creationhub-postgres:5432/${POSTGRES_DB:-postgres}
      - GLANCES_URL=${GLANCES_URL:-http://host.docker.internal:61208/api/4}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default
      - creationhub-backend
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================
  # System API (Docker Monitoring)
  # ===========================================
  system-api:
    build: ./system-api
    container_name: creationhub_system_api
    restart: always
    ports:
      - "9191:9191"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/os-release:/host-os-release:ro
      - /proc:/host-proc:ro
      - /sys:/host-sys:ro
      - /etc/wireguard:/etc/wireguard
      - /home/inno/compose/backups:/backups:ro  # Backup files access
      - /home/inno/compose/backups:/backups
      - ./system-api/data:/app/data
    environment:
      - WG_CONFIG_DIR=/etc/wireguard
      - OS_RELEASE_PATH=/host-os-release
      - RESOLV_CONF_PATH=/host-resolv.conf
      - BACKUP_DIR=/backups
      - POSTGRES_URL=postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-changeme}@creationhub-postgres:5432/${POSTGRES_DB:-postgres}
    networks:
      - default
      - creationhub-backend
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9191/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================
  # Ollama (AI Chat)
  # ===========================================
  ollama:
    image: ollama/ollama:latest
    container_name: creationhub_ollama
    restart: always
    runtime: nvidia
    ports:
      - "11434:11434"
    volumes:
      - ${AI_DATA_PATH:-./ai_data}:/root/.ollama
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 2G
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================
  # AI Gateway (On-Demand Service Manager)
  # ===========================================
  ai-gateway:
    build: ./ai-gateway
    container_name: creationhub_ai_gateway
    restart: always
    profiles: ["ai-gateway"]  # Only starts with: docker compose --profile ai-gateway up
    ports:
      - "9292:9292"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - JWT_SECRET=${JWT_SECRET:-super-secret-jwt-key-for-creationhub-2024}
    networks:
      - default
      - creationhub-backend
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"



  # ===========================================
  # PostgreSQL Database (Core)
  # ===========================================
  creationhub-postgres:
    image: postgres:16-alpine
    container_name: creationhub_postgres
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
    volumes:
      - ./volumes/postgres:/var/lib/postgresql/data
      - ./init_db.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - default
      - creationhub-backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ===========================================
  # Redis (Cache & Queue)
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: creationhub_redis
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD:-changeme}
    volumes:
      - ./volumes/redis:/data
    networks:
      - default
      - creationhub-backend
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-changeme}", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ===========================================
  # Adminer (DB Management)
  # ===========================================
  adminer:
    image: adminer
    container_name: creationhub_adminer
    restart: always
    ports:
      - "8083:8080"
    networks:
      - default
      - creationhub-backend

networks:
  creationhub-backend:
    external: true


